---
layout: IT
title: AWS Elastic Beanstalk 배포 설정
date: '2014-08-05'
comments: true
adsense: true
ignored: false
tags:
- aws
- Elastic Beanstalk
- flask
- IT
- Python
- "구축"
- "배포"
- "환경"
---

<h2 id="article_summary" class="summary">아마존 AWS Elastic Beanstalk에 Python Flask 배포환경 구축을 위한 설정</h2>아마존 Elastic Beanstalk은 애플리케이션을 올리기만 하면 Elastic Beanstalk이 용량 프로비저닝, 로드 밸런싱, 자동 조정,<br />애플리케이션 상태 모니터링에 대한 배포 정보를 자동으로 처리한다.<br />개발자는 개발에만 신경 쓰면 인프라는 아마존에서 다 해주겠다는 말이다.<br />이 얼마나 반가운 소리인가?<br />그러나 막상 Elastic Beanstalk를 쓰려면 손수 설정해야 하는 부분이 많다.<br />이 글에서는 static 파일을 아마존 CDN인 CloudFront를 통해 제공한다는 가정하에 크게 세 부분으로 나누어 설명하겠다.<br />첫째는 아마존 콘솔 단에서 IAM,S3,CloudFront설정이고,<br />둘째는 Elastic Beanstalk .ebextensions 설정.<br />마지막은 Python boto를 이용한 배포 스크립트다.<br />게으른 개발자로서 좀 편해 보고자 아마존 AWS Elastic Beanstalk을 쓰면서 환경 설정 때문에 애를 많이 먹었다.<br />AWS Elastic Beanstalk을 고려 중인 또 다른 개발자가 이 글을 읽고 같은 삽질을 않으면 좋겠다.<br /><br /><h3>AWS 콘솔 설정</h3><h4>IAM 설정</h4>배포 권한을 가진 Group를 만든다.<br />예제에서 그룹명은 Dorajistyle-deploy로 하겠다.<br />User인 dorajistyle은 Dorajistyle-deploy 그룹에 소속되어, 배포시에 dorajistyle유저 정보로 배포하게 된다.<br />Dorajistyle-deploy그룹은 아래의 policy를 가진다.<br /><code><pre>{<br />  "Version": "2012-10-17",<br />  "Statement": [<br />     {<br />      "Effect": "Allow",<br />      "Action": [<br />        "elasticbeanstalk:*",<br />        "ec2:*",<br />        "elasticloadbalancing:*",<br />        "autoscaling:*",<br />        "cloudwatch:*",<br />        "s3:*",<br />        "sns:*",<br />        "cloudformation:*",<br />        "rds:*",<br />        "iam:AddRoleToInstanceProfile",<br />        "iam:CreateInstanceProfile",<br />        "iam:CreateRole",<br />        "iam:PassRole",<br />        "iam:ListInstanceProfiles"<br />      ],<br />      "Resource": "*"<br />    },<br />    {<br />      "Sid": "QueueAccess",<br />      "Action": [<br />        "sqs:ChangeMessageVisibility",<br />        "sqs:DeleteMessage",<br />        "sqs:ReceiveMessage"<br />      ],<br />      "Effect": "Allow",<br />      "Resource": "*"<br />    },<br />    {<br />      "Sid": "MetricsAccess",<br />      "Action": [<br />        "cloudwatch:PutMetricData"<br />      ],<br />      "Effect": "Allow",<br />      "Resource": "*"<br />    },<br />    {<br />      "Sid": "Stmt110100200000",<br />      "Effect": "Allow",<br />      "Action": [<br />        "s3:*"<br />      ],<br />      "Resource": [<br />        "arn:aws:s3:::dorajistyle/*",<br />        "arn:aws:s3:::dorajistyle",<br />        "arn:aws:s3:::dorajistyle-static/*",<br />        "arn:aws:s3:::dorajistyle-static",<br />        "arn:aws:s3:::dorajistyle-deploy/*",<br />        "arn:aws:s3:::dorajistyle-deploy",<br />        "arn:aws:s3:::elasticbeanstalk-ap-northeast-1-000000000000",<br />        "arn:aws:s3:::elasticbeanstalk-ap-northeast-1-000000000000/*"<br />      ]<br />    },<br />    {<br />      "Sid": "Stmt130000013000",<br />      "Effect": "Allow",<br />      "Action": [<br />        "rds:*"<br />      ],<br />      "Resource": [<br />        "arn:aws:rds:ap-northeast-1:000000000000:db:dorajistyle"<br />      ]<br />    },<br />{<br />      "Sid": "Stmt1399636332000",<br />      "Effect": "Allow",<br />      "Action": [<br />        "elasticbeanstalk:*"<br />      ],<br />      "Resource": ["*","arn:aws:elasticbeanstalk:ap-northeast-1:000000000000:application/dorajistyle",<br />"arn:aws:elasticbeanstalk:ap-northeast-1:000000000000:environment/dorajistyle/dorajistyle"<br />,"arn:aws:elasticbeanstalk:ap-northeast-1:000000000000:applicationversion/dorajistyle/*"]<br />    },<br />    {<br />      "Effect": "Allow",<br />      "Action": [<br />        "cloudformation:DescribeStacks",<br />        "cloudformation:DescribeStackEvents",<br />        "cloudformation:DescribeStackResources",<br />        "cloudformation:GetTemplate",<br />        "cloudformation:List*"<br />      ],<br />      "Resource": "*"<br />    }<br /></pre></code><br /><br /><h4>S3 설정</h4>S3버켓은 총 3개가 필요하다.<br /><br /><h5>dorajistyle-deploy</h5>배포용 zip파일을 업로드할 버켓이다. 사용자 dorajistyle만 접근 가능하며, 버켓 설정은 기본 그대로 사용하면 된다.<br /><br /><h6>CORS Configuration</h6><code><pre>&lt;CORSConfiguration&gt;<br />    &lt;CORSRule&gt;<br />        &lt;AllowedOrigin&gt;*&lt;/AllowedOrigin&gt;<br />        &lt;AllowedMethod&gt;GET&lt;/AllowedMethod&gt;<br />        &lt;MaxAgeSeconds&gt;3000&lt;/MaxAgeSeconds&gt;<br />        &lt;AllowedHeader&gt;Authorization&lt;/AllowedHeader&gt;<br />    &lt;/CORSRule&gt;<br />&lt;/CORSConfiguration&gt;</pre></code><br /><br /><h5>dorajistyle-static</h5>static 파일을 저장할 버켓이다. 누구나 읽을 수 있는 버켓이다.<br /><br /><h6>Bucket policy</h6><code><pre>{<br /> "Version": "2008-10-17",<br /> "Id": "Policy1394587645145",<br /> "Statement": [<br />  {<br />   "Sid": "Stmt1394587643817",<br />   "Effect": "Allow",<br />   "Principal": {<br />    "AWS": "*"<br />   },<br />   "Action": "s3:GetObject",<br />   "Resource": "arn:aws:s3:::dorajistyle-static/*"<br />  }<br /> ]<br />}</pre></code><br /><br /><h6>CORS Configuration</h6><code><pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;CORSConfiguration xmlns="http://s3.amazonaws.com/doc/2006-03-01/"&gt;<br />    &lt;CORSRule&gt;<br />        &lt;AllowedOrigin&gt;http://*.dorajistyle.pe.kr&lt;/AllowedOrigin&gt;<br />        &lt;AllowedMethod&gt;PUT&lt;/AllowedMethod&gt;<br />        &lt;AllowedMethod&gt;POST&lt;/AllowedMethod&gt;<br />        &lt;AllowedMethod&gt;DELETE&lt;/AllowedMethod&gt;<br />        &lt;AllowedHeader&gt;*&lt;/AllowedHeader&gt;<br />    &lt;/CORSRule&gt;<br />    &lt;CORSRule&gt;<br />        &lt;AllowedOrigin&gt;http://*.www.dorajistyle.pe.kr&lt;/AllowedOrigin&gt;<br />        &lt;AllowedMethod&gt;PUT&lt;/AllowedMethod&gt;<br />        &lt;AllowedMethod&gt;POST&lt;/AllowedMethod&gt;<br />        &lt;AllowedMethod&gt;DELETE&lt;/AllowedMethod&gt;<br />        &lt;AllowedHeader&gt;*&lt;/AllowedHeader&gt;<br />    &lt;/CORSRule&gt;<br />    &lt;CORSRule&gt;<br />        &lt;AllowedOrigin&gt;http://dorajistyle.elasticbeanstalk.com&lt;/AllowedOrigin&gt;<br />        &lt;AllowedMethod&gt;PUT&lt;/AllowedMethod&gt;<br />        &lt;AllowedMethod&gt;POST&lt;/AllowedMethod&gt;<br />        &lt;AllowedMethod&gt;DELETE&lt;/AllowedMethod&gt;<br />        &lt;AllowedHeader&gt;*&lt;/AllowedHeader&gt;<br />    &lt;/CORSRule&gt;<br />    &lt;CORSRule&gt;<br />        &lt;AllowedOrigin&gt;*&lt;/AllowedOrigin&gt;<br />        &lt;AllowedMethod&gt;GET&lt;/AllowedMethod&gt;<br />        &lt;AllowedHeader&gt;Authorization&lt;/AllowedHeader&gt;<br />        &lt;AllowedHeader&gt;x-requested-with&lt;/AllowedHeader&gt;<br />        &lt;AllowedHeader&gt;origin&lt;/AllowedHeader&gt;<br />    &lt;/CORSRule&gt;<br />&lt;/CORSConfiguration&gt;</pre></code><br /><br /><h5>dorajistyle</h5>이미지등의 유저 컨텐츠를 저장할 버켓이다.<br />예제에서는 모든 유저가 읽을 수 있도록 설정되었는데, 이는 사용 용도에 따라 변경이 가능하다.<br /><br /><h6>Bucket Policy</h6><code><pre>{<br /> "Version": "2008-10-17",<br /> "Id": "Policy1394587559249",<br /> "Statement": [<br />  {<br />   "Sid": "Stmt1394587510887",<br />   "Effect": "Allow",<br />   "Principal": {<br />    "AWS": "*"<br />   },<br />   "Action": "s3:GetObject",<br />   "Resource": "arn:aws:s3:::dorajistyle/*"<br />  }<br /> ]<br />}</pre></code><br /><br /><h6>CORS Configuration</h6><code><pre>&lt;CORSConfiguration&gt;<br />    &lt;CORSRule&gt;<br />        &lt;AllowedOrigin&gt;*&lt;/AllowedOrigin&gt;<br />        &lt;AllowedMethod&gt;GET&lt;/AllowedMethod&gt;<br />        &lt;MaxAgeSeconds&gt;3000&lt;/MaxAgeSeconds&gt;<br />        &lt;AllowedHeader&gt;Authorization&lt;/AllowedHeader&gt;<br />    &lt;/CORSRule&gt;<br />&lt;/CORSConfiguration&gt;</pre></code><br /><br /><h4>CloudFront 설정</h4>dorajsityle-static S3에 CloudFront를 연결한다.<br />Origin Domain Name에 S3 버켓 주소를 적으면 된다.<br />만약 CloudFront에 연결이 잘 되었는데도 리소스를 찾지 못한다면 Invalidations에서 해당 리소스를 무효화한다.<br /><br /><h3>.ebextensions 설정</h3>Elastic Beanstalk에 어플리케이션을 올리면 마법처럼 돌아간다고는 하지만,<br />각 어플리케이션마다 필요한 라이브러리를 모두 설치해 둘 순 없다.<br />그래서 .ebextensions 설정을 통해 각 어플리케이션에 맞는 라이브러리 설치와, 서버 설정 변경등이 가능하다.<br />.ebextensions에 대한 설명은 아마존의 컨테이너 맞춤 설정 안내(<a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers.html" target="_blank">http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers.html</a>)를 참조하면 된다.<br />이 글에서는 yum 패키지 업데이트와 라이브러리 설치, 배포 hook 설정 변경과 아파치 서버 변경을 다룬다.<br /><br /><h4>01_yum_update.config</h4>yum 패키지를 업데이트 한다.<br /><code><pre>commands:<br />  yum_updates: <br />    command: "yum --security update -y"</pre></code><br /><br /><h4>02_package_update.config</h4>필요한 yum 패키지를 설치한다.<br />packages키를 이용해도 되지만, 충돌이 일어날 경우 command키를 이용한 설치도 한 방법이다.<br /><code><pre>commands:<br />  yum_package_updates: <br />    command: "yum install python-devel python-pip libtiff-devel libjpeg-turbo-devel libzip-devel freetype-devel lcms2-devel tcl-devel php -y --skip-broken"</pre></code><br /><br /><h4>03_pre_requirements.config</h4>Elastic Beanstalk에 파이썬 어플리케이션을 업로드 하면,<br />requirements.txt파일을 찾아 필요한 파이썬 라이브러리를 자동으로 설치해 준다.<br />그런데 간혹 한번에 설치가 안되어 나누어 설치해야 하는 라이브러리가 있다.<br />몇몇 라이브러리를 설치할때 pip에서 발생하는 문제로 미리 설치할 라이브러리를 pre_requirements.txt에 넣어두고 먼저 설치하면 문제없이 설치된다.<br />다만 pre_requirements.txt 파일을 먼저 설치하려면 배포 hook코드를 변경해야 한다.<br /><code><pre>files:<br />  "/opt/elasticbeanstalk/hooks/appdeploy/pre/03deploy.py":<br />    mode: "000755"<br />    owner: root<br />    group: users<br />    content: |<br />      #!/usr/bin/env python<br />      import os<br />      from subprocess import call, check_call<br />      import sys<br />      sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))<br />      import config<br /><br /><br />      def install_virtualenv():<br />          # If python 2.7 is installed, make the virtualenv use it. Else use the default system 2.6<br />          if config.get_python_version() == '2.7':<br />              cmd = 'virtualenv -p /usr/bin/python27 {0}'<br />          else:<br />              cmd = 'virtualenv {0}'<br /><br />          return_code = call(cmd.format(config.APP_VIRTUAL_ENV), shell=True)<br /><br />          if return_code != 0:<br />              print "WARN: error running '%s'" % cmd<br /><br /><br />      def install_dependencies():<br />          pre_requirements_file = os.path.join(config.ON_DECK_DIR, 'app', 'pre_requirements.txt')<br />          requirements_file = os.path.join(config.ON_DECK_DIR, 'app', 'requirements.txt')<br />          if os.path.exists(pre_requirements_file):<br />              check_call('%s install --use-mirrors -r %s' % (os.path.join(config.APP_VIRTUAL_ENV, 'bin', 'pip'), pre_requirements_file), shell=True)<br />          if os.path.exists(requirements_file):<br />              # Note, we're sharing the virtualenv across multiple deploys, which implies<br />              # this is an additive operation. This is normally not a problem and is done<br />              # to minimize deployment time (the requirements are not likely to drastically<br />              # change between deploys).<br />              check_call('%s install --use-mirrors -r %s' % (os.path.join(config.APP_VIRTUAL_ENV, 'bin', 'pip'), requirements_file), shell=True)<br /><br /><br />      def main():<br />          try:<br />              install_virtualenv()<br />              install_dependencies()<br />          except Exception, e:<br />              config.emit_error_event(config.USER_ERROR_MESSAGES['badrequirements'])<br />              config.diagnostic("Error installing dependencies: %s" % str(e))<br />              sys.exit(1)<br /><br />      if __name__ == '__main__':<br />          config.configure_stdout_logger()<br />          main()</pre></code><br /><br /><h4>04_wsgi.config</h4>아파치 서버 설정 파일을 입맛에 맞게 변경한다. wsgi.conf 파일을 .ebextensions 폴더에 넣어두고,<br />wsgi.config 훅에 아래 코드를 넣으면 서버로 설정을 복사한다.<br /><code><pre>container_commands:<br />  replace_wsgi_config:<br />    command: "cp .ebextensions/wsgi.conf /opt/python/ondeck/wsgi.conf"</pre></code><br /><br /><h4>wsgi.conf</h4>캐쉬와 gzip압축등 설정을 담았다.<br /><code><pre># LoadModule wsgi_module modules/mod_wsgi.so<br />WSGIPythonHome /opt/python/run/baselinenv<br />WSGISocketPrefix run/wsgi<br />WSGIRestrictEmbedded On<br /><br />&lt;VirtualHost *:80&gt;<br />###############<br /># TYPES FIX #<br />###############<br />AddType text/css .css<br />AddType text/javascript .js<br /><br />############################<br /># IE 11 Prevent Cache      #<br />############################<br />BrowserMatch "MSIE 11.0;" IE11FOUND<br />BrowserMatch "Trident/7.0;" IE11FOUND<br /># FileETag None<br />Header unset ETag env=IE11FOUND<br />Header set Cache-Control "max-age=0, no-cache, no-store, must-revalidate"  env=IE11FOUND<br />Header set Pragma "no-cache" env=IE11FOUND<br />Header set Expires "Thu, 24 Feb 1983 02:50:00 GMT" env=IE11FOUND<br /><br />####################################<br /># Serve Pre-Compressed statics #<br />####################################<br />RewriteEngine On<br />RewriteCond %{HTTP:Accept-encoding} gzip<br />RewriteCond %{REQUEST_FILENAME}\.gz -s<br />RewriteRule ^(.*)\.(html|css|js|json|woff) $1\.$2\.gz [QSA]<br /><br /># Prevent double gzip and give the correct mime-type<br />RewriteRule \.css\.gz$ - [T=text/css,E=no-gzip:1,E=FORCE_GZIP]<br />RewriteRule \.js\.gz$ - [T=text/javascript,E=no-gzip:1,E=FORCE_GZIP]<br />RewriteRule \.html\.gz$ - [T=text/html,E=no-gzip:1,E=FORCE_GZIP]<br />RewriteRule \.json\.gz$ - [T=application/json,E=no-gzip:1,E=FORCE_GZIP]<br />RewriteRule \.woff\.gz$ - [T=application/x-font-woff,E=no-gzip:1,E=FORCE_GZIP]<br /><br />Header set Content-Encoding gzip env=FORCE_GZIP<br /><br />#######################<br /># GZIP COMPRESSION #<br />######################<br />SetOutputFilter DEFLATE<br />AddOutputFilterByType DEFLATE text/html text/css text/plain text/xml text/javascript application/x-javascript application/x-httpd-php<br />BrowserMatch ^Mozilla/4 gzip-only-text/html<br />BrowserMatch ^Mozilla/4\.0[678] no-gzip<br />BrowserMatch \bMSIE !no-gzip !gzip-only-text/html<br />BrowserMatch \bMSI[E] !no-gzip !gzip-only-text/html<br />SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png)$ no-gzip<br />Header append Vary User-Agent env=!dont-vary<br /><br />################################<br /># Leverage browser caching #<br />###############################<br />&lt;FilesMatch ".(ico|pdf|jpg|jpeg|png|gif|html|htm|xml|txt|xsl)$"&gt;<br />Header set Cache-Control "max-age=31536050"<br />&lt;/FilesMatch&gt;<br /><br />############################<br /># CDN Rewrite Setting   #<br />############################<br /># Header set Access-Control-Allow-Origin: "*"<br /># UseCanonicalName On<br /># Don't redirect if the static hostname(s) loops back.<br /># RewriteCond %{HTTP_HOST} !^static\.<br /># Include only those static file extensions that we want to off-load.<br /># RewriteCond %{REQUEST_FILENAME} ^/.*\.(html|xml|txt|zip|gz|tgz|swf|mov|wmv|wav|mp3|pdf|svg|otf|eot|ttf|woff|jpg|jpeg|png|gif|ico|css|js|json)$<br /># RewriteRule /static/(.*)? http://static.dorajistyle.pe.kr/$1 [redirect=permanent,last]<br /><br />#########################<br /># WSGI configuration #<br />#########################<br /><br />WSGIScriptAlias / /opt/python/current/app/application.py<br /><br />&lt;Directory /opt/python/current/app/&gt;<br /># Order allow,deny<br /># Allow from all<br />Require all granted<br />&lt;/Directory&gt;<br /><br />WSGIDaemonProcess wsgi processes=1 threads=15 display-name=%{GROUP} \<br />python-path=/opt/python/current/app:/opt/python/run/venv/lib/python2.7/site-packages user=wsgi group=wsgi \<br />home=/opt/python/current/app<br />WSGIProcessGroup wsgi<br /># WSGIScriptReloading On<br />&lt;/VirtualHost&gt;</pre></code><br /><br /><h3>배포 스크립트.</h3><br /><h4>deploy.sh</h4>static폴더를 최적화하고, DB스키마가 변경되었을 경우 업데이트 하며, 필요한 파일만 압축하여 aws에 올린다.<br />optimize_static.sh와 upload_to_aws.py이 중요하다.<br /><code><pre>#!/bin/bash<br />STARTTIME=$(date +%s)<br />./optimize_static.sh<br />rm *.zip<br />prefix=$(sed -n '/^PREFIX/ s/.*\= *//p' ./application/config/guid.py | tr -d \')<br />guid=$(sed -n '/^GUID/ s/.*\= *//p' ./application/config/guid.py | tr -d \')<br />name="$prefix-$guid"<br />zip -r $name * ./.ebextensions/* -x ./.git\* ./.idea\* ./docs\* ./node_modules\* ./alembic\* ./tests\* ./images\* *.zip  *.DS_Store  ./application/frontend/static/\*<br />zip_file=$name'.zip'<br />echo "$zip_file"<br />echo -e "Do you want to upgrade alembic schema? (Yes/No) : \c"<br />read ANSWER<br />if [ "$ANSWER" == "Yes" ]<br />then<br />    alembic revision --autogenerate -m "Alembic initilized boilerplate tables."<br />fi<br />echo -e "Do you want to update schema? (Yes/No) : \c"<br />read ANSWER<br />if [ "$ANSWER" == "Yes" ]<br />then<br />    alembic upgrade head<br />fi<br />echo -e "Did you reviewed source and confirmed running status? (Yes/No) : \c"<br />read ANSWER<br />if [ "$ANSWER" == "Yes" ]<br />then<br />    python2 upload_to_aws.py $name<br />else<br />    echo "Checking status and trying to deploy again."<br />fi<br />ENDTIME=$(date +%s)<br />echo "$name"<br />echo "It takes $(($ENDTIME - $STARTTIME)) seconds to complete this task..."</pre></code><br /><br /><h4>optimize_static.sh</h4>guid를 생성하고 총 4개까지 히스토리를 남긴다. 혹시 배포가 잘못되어 롤백을 하게될 경우 이전 4버전까지 롤백이 가능하도록 한다.<br />테스트 서버에 먼저 배포하여 테스트 하고 문제가 없으면 실 서버에 배포를 하기 때문에 실 서버에서 4버전이나 롤백할 가능성은 상당히 희박하다.<br />static 파일은 require optimizer를 사용해 하나의 js와 하나의 css파일로 합치고, sed를 이용해 디버깅을 위해 사용하던 로그 코드와 공백을 날려 용량을 줄인다.<br />그리고 각 파일을 gzip으로 압축하여 용량을 다시 한번 줄인다.<br /><code><pre>#!/bin/bash<br />guid=$(uuidgen | tr -d '\n-' | tr '[:upper:]' '[:lower:]')<br />guid=${guid:0:8}<br />today=$(date '+%Y%m%d')<br />guid=$today'-'$guid<br />echo "$guid"<br />extremely_very_old_guid=$(sed -n '/^VERY_OLD_GUID/ s/.*\= *//p' ./application/config/guid.py)<br />sed -i "s/^EXTREMELY_VERY_OLD_GUID = .*/EXTREMELY_VERY_OLD_GUID = $extremely_very_old_guid/" ./application/config/guid.py<br />very_old_guid=$(sed -n '/^OLD_GUID/ s/.*\= *//p' ./application/config/guid.py)<br />sed -i "s/^VERY_OLD_GUID = .*/VERY_OLD_GUID = $very_old_guid/" ./application/config/guid.py<br />old_guid=$(sed -n '/^GUID/ s/.*\= *//p' ./application/config/guid.py)<br />sed -i "s/^OLD_GUID = .*/OLD_GUID = $old_guid/" ./application/config/guid.py<br />sed -i "s/^GUID = .*/GUID = '$guid'/" ./application/config/guid.py<br />cd './application/frontend/compiler/'<br />grunt static<br />grunt --gruntfile Gruntfile_uncss.js<br />cd '../../..'<br />cd './optimizer'<br />node ./r.js -o build.js<br />cd "../"<br />sed -i -r "s/(\ ?|\ +),(\ ?|\ +)[a-zA-Z]\.log(Error|Json|Object|Trace|Debug|Info|Warn)(\ ?|\ +)\([^)]*\)(\ ?|\ +),(\ ?|\ +)/,/g" ./application/frontend/static-build/js/app.js<br />sed -i -r "s/(\ ?|\ +),(\ ?|\ +)[a-zA-Z]\.log(Error|Json|Object|Trace|Debug|Info|Warn)(\ ?|\ +)\([^)]*\)(\ ?|\ +),?(\ ?|\ +);/;/g" ./application/frontend/static-build/js/app.js<br />sed -i -r "s/(\ ?|\ +),?(\ ?|\ +)[a-zA-Z]\.log(Error|Json|Object|race|Debug|Info|Warn)(\ ?|\ +)\([^)]*\)(\ ?|\ +),?(\ ?|\ +);//g" ./application/frontend/static-build/js/app.js<br />sed -i -r "s/(\ ?|\ +),?(\ ?|\ +)[a-zA-Z]\.log(Error|Json|Object|race|Debug|Info|Warn)(\ ?|\ +)\([^)]*\)(\ ?|\ +),?(\ ?|\ +);?/\n/g" ./application/frontend/static-build/js/app.js<br /><br />cd './application/frontend/static-build/locales'<br />find . -name '*.json' -exec sed -i '/^\s∗\/\//d' {} \;<br />find . -name '*.json' -exec sed -i 's/^[ \t]*//g; s/[ \t]*$//g;' {} \;<br />find . -name '*.json' -exec sed -i ':a;N;$!ba;s/\n/ /g' {} \;<br />find . -name '*.json' -exec sed -i 's/\"\s*:\s*\"/\":\"/g' {} \;<br />find . -name '*.json' -exec sed -i 's/\"\s*,\s*\"/\",\"/g' {} \;<br />find . -name '*.json' -exec sed -i 's/\s*{\s*/{/g' {} \;<br />find . -name '*.json' -exec sed -i 's/\s*}\s*/}/g' {} \;<br />cd '../..'<br />gzip -r --best ./static-build<br />rename .gz '' `find static-build -name '*.gz'`</pre></code><br /><br /><h4>upload_to_aws.py</h4>보토를 이용해 Elastic Beanstalk을 업데이트 한다. 배포가 끝나면 guid를 검사하여 오래된 버전 소스를 삭제한다.<br />static파일 업로드에서 눈여겨 볼 점은 key에 Content_Encoding 메타 데이터를 gzip으로 해 주어야 하는 것이다.<br />이는 위의 optimize static에서 이미 gzip으로 압축했기 때문이다.<br /><br /><pre><code># coding=UTF-8<br />"""<br />    application.util.__init__<br />    ~~~~~~~~~~~~~~~~~~~~~~~~~~<br />    by dorajistyle<br /><br />    __init__ module<br /><br />"""<br />from Queue import Queue<br />import logging<br />import os<br />import string<br />import boto<br />from boto.beanstalk import connect_to_region<br />import sys<br /># import time<br />from application.config.aws import AWS_STATIC_S3_BUCKET_NAME, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, \<br />    AWS_ELASTIC_BEANSTALK_REGION, AWS_ELASTIC_BEANSTALK_APP_NAME, AWS_ELASTIC_BEANSTALK_ENVIRONMENT_ID, \<br />    AWS_ELASTIC_BEANSTALK_ENVIRONMENT_NAME, AWS_ELASTIC_BEANSTALK_S3_BUCKET_NAME<br />from application.config.guid import OLD_GUID, VERY_OLD_GUID, PREFIX_GUID, EXTREMELY_VERY_OLD_GUID<br />from application.properties import STATIC_GUID<br />from threading import Thread<br />logging.basicConfig()<br />logger = logging.getLogger()<br /><br /><br />def log_exception(text):<br />    logger.error(msg=text)<br /><br />q = Queue()<br /># source directory<br />sourceDir = 'application/frontend/static-build/'<br /># destination directory name (on s3)<br />destDir = STATIC_GUID+'/'<br /><br />conn = boto.connect_s3(AWS_ACCESS_KEY_ID,<br />                       AWS_SECRET_ACCESS_KEY)<br />bucket = conn.get_bucket(AWS_STATIC_S3_BUCKET_NAME)<br />eb_bucket = conn.get_bucket(AWS_ELASTIC_BEANSTALK_S3_BUCKET_NAME)<br />keys = list()<br />old_keys = list()<br />eb_keys = list()<br />for key in bucket.list():<br />    keys.append(key.name)<br />for key in eb_bucket.list():<br />    eb_keys.append(key.name)<br />eb = connect_to_region(AWS_ELASTIC_BEANSTALK_REGION,<br />                       aws_access_key_id=AWS_ACCESS_KEY_ID,<br />                       aws_secret_access_key=AWS_SECRET_ACCESS_KEY)<br />uploadDirNames = []<br />uploadFileNames = []<br />for path in os.listdir( sourceDir ):<br />    if not os.path.isfile(os.path.join( sourceDir, path)):<br />        uploadDirNames.append(path+'/')<br /><br /><br />for (sourceDir, dirnames, filenames) in os.walk(sourceDir):<br />    for subDir in dirnames:<br />        # print('dirname:'+ subDir)<br />        for (subDir, sub_dirnames, subfilenames) in os.walk(sourceDir+subDir):<br />            for subfilename in subfilenames:<br />                sub_path = string.replace(subDir, sourceDir, '')<br />                uploadFileNames.append(os.path.join(sub_path, subfilename))<br />    uploadFileNames.extend(filenames)<br />    break<br /><br /><br />def percent_cb(complete, total):<br />    sys.stdout.write('.')<br />    sys.stdout.flush()<br /><br /><br />def upload_deploy(source_path, dest_path):<br />    """<br />    Upload static files to S3 bucket.<br />    :return:<br />    """<br /><br />    try:<br />        dest_path = dest_path.encode('utf-8')<br />        key = eb_bucket.new_key(dest_path)<br />        key.set_contents_from_filename(source_path,<br />                                       cb=percent_cb, num_cb=10)<br />    except BaseException as be:<br />        log_exception(be)<br />        return False<br />    return True<br /><br /><br />def upload_static(source_path, dest_path):<br />    """<br />    Upload static files to S3 bucket.<br />    :return:<br />    """<br /><br />    try:<br />        dest_path = dest_path.encode('utf-8')<br />        key = bucket.new_key(dest_path)<br />        # if key.name.endswith(('.gz', '.gzip')):<br />        key.set_metadata('Content-Encoding', 'gzip')<br />        key.set_contents_from_filename(source_path,<br />                                       cb=percent_cb, num_cb=10)<br />    except BaseException as be:<br />        log_exception(be)<br />        return False<br />    return True<br /><br /><br />def worker():<br />    while True:<br />        item = q.get()<br />        if item['source_path'] == item['dest_path']:<br />            upload_deploy(item['source_path'], item['dest_path'])<br />        else:<br />            upload_static(item['source_path'], item['dest_path'])<br />        q.task_done()<br />        print 'Uploading %s to Amazon S3 bucket %s' % \<br />              (item['source_path'], item['dest_path'])<br /><br /># threads = []<br />if len(sys.argv) == 2:<br />    eb_app = eb.describe_applications(application_names=AWS_ELASTIC_BEANSTALK_APP_NAME)<br />    versions = eb_app['DescribeApplicationsResponse']['DescribeApplicationsResult']['Applications'][0]['Versions']<br />    # if len(versions) &gt; 2:<br />    #     versions = versions[:2]<br />    latest_version = PREFIX_GUID.replace('\'', '')+'-'+OLD_GUID.replace('\'', '')<br />    very_old_version = PREFIX_GUID.replace('\'', '')+'-'+VERY_OLD_GUID.replace('\'', '')<br />    extremely_very_old_version = PREFIX_GUID.replace('\'', '')+'-'+EXTREMELY_VERY_OLD_GUID.replace('\'', '')<br />    try:<br />        if latest_version in versions:<br />            versions.remove(latest_version)<br />        if very_old_version in versions:<br />            versions.remove(very_old_version)<br />        if extremely_very_old_version in versions:<br />            versions.remove(extremely_very_old_version)<br /><br />        for key in bucket.list(prefix=OLD_GUID.replace('\'', '')):<br />            keys.remove(key.name)<br />        for key in bucket.list(prefix=VERY_OLD_GUID.replace('\'', '')):<br />            keys.remove(key.name)<br />        for key in bucket.list(prefix=EXTREMELY_VERY_OLD_GUID.replace('\'', '')):<br />            keys.remove(key.name)<br /><br />        for eb_key in eb_bucket.list(prefix=latest_version):<br />            eb_keys.remove(eb_key.name)<br />        for eb_key in eb_bucket.list(prefix=very_old_version):<br />            eb_keys.remove(eb_key.name)<br />        for eb_key in eb_bucket.list(prefix=extremely_very_old_version):<br />            eb_keys.remove(eb_key.name)<br /><br />        file_name = sys.argv[1]<br />        zip_file = file_name + '.zip'<br />        for i in range(8):<br />            t = Thread(target=worker)<br />            t.daemon = True<br />            t.start()<br />        item = {}<br />        item['source_path'] = zip_file<br />        item['dest_path'] = zip_file<br />        q.put(item)<br />        for filename in uploadFileNames:<br />            source_path = os.path.join(sourceDir + filename)<br />            dest_path = os.path.join(destDir, filename)<br />            item = {}<br />            item['source_path'] = source_path<br />            item['dest_path'] = dest_path<br />            q.put(item)<br />        q.join()<br />        eb.create_application_version(AWS_ELASTIC_BEANSTALK_APP_NAME, version_label=file_name,<br />                                      description=None, s3_bucket=AWS_ELASTIC_BEANSTALK_S3_BUCKET_NAME, s3_key=zip_file)<br />        eb.update_environment(environment_id=AWS_ELASTIC_BEANSTALK_ENVIRONMENT_ID,<br />                              environment_name=AWS_ELASTIC_BEANSTALK_ENVIRONMENT_NAME,<br />                              version_label=file_name)<br />        bucket.delete_keys(keys)<br />        eb_bucket.delete_keys(eb_keys)<br />        for version in versions:<br />            eb.delete_application_version(application_name=AWS_ELASTIC_BEANSTALK_APP_NAME, version_label=version, delete_source_bundle=False)<br />    except BaseException as be:<br />        print(str(be))<br />        if latest_version is not None:<br />            eb.update_environment(environment_id=AWS_ELASTIC_BEANSTALK_ENVIRONMENT_ID,<br />                                  environment_name=AWS_ELASTIC_BEANSTALK_ENVIRONMENT_NAME,<br />                                  version_label=latest_version)<br />    # print('eb application' + str(eb.retrieve_environment_info(environment_id=AWS_ELASTIC_BEANSTALK_ENVIRONMENT_ID,<br />    #                       environment_name=AWS_ELASTIC_BEANSTALK_ENVIRONMENT_NAME)))<br />    print('AWS Elastic Beanstalk updated.')<br />print('Bye Bye!')</code></pre>
