---
layout: IT
title: Flask+RequireJS. static 폴더 최적화 하기.
date: '2013-08-31'
comments: true
adsense: true
ignored: false
tags:
- development
- flask
- IT
- optimizer
- requireJS
- static
- web
- "최적화"
---

<h2 id="article_summary" class="summary">파이썬 Flask에서 RequireJS Optimizer를 이용한 static폴더 최적화.</h2><p>자바스크립트MVC를 이용할 경우 자바스크립트와 뷰 템플릿때문에 static폴더가 무겁습니다.<br />파일의 공백을 모두 제거하여 용량을 줄이면 좀 가벼워 지지요.<br />허나 파일 공백을 없애면 가독성이 떨어집니다.<br />난감한 상황이 발생해요.<br />길이 1m짜리 한줄코드를 고치고 기능 추가하는건 어렵잖아요?<br />변경이 빈번하게 일어나는 static 폴더.<br />개발 편의와 성능 두마리 토끼를 잡을 좋은 수가 없을까요?<br />RequireJS를 이용해 자바스크립트를 관리하신다면 방법이 있습니다!</p><h3>우선 노드JS(<a href="http://nodejs.org" target="_blank" title="NodeJS">http://nodejs.org</a>)를 설치합니다.</h3><h3>RequireJS Optimizer를 설치합니다.</h3><p><code>npm install -g requirejs</code></p><h3>3. r.js를 다운로드 받습니다.(http://requirejs.org/docs/release/2.1.8/r.js)</h3><h3>4. 예제에서 사용할 어플리케이션 디렉토리 구조는 다음과 같습니다.</h3><p><pre>/build<br />  - r.js<br />  - build.js<br />/application<br />  __init__.py<br />  /static<br />    /views<br />      template.ejs<br />    /js<br />      app.js<br />      /vendor<br />        jquery-1.10.1.min.js<br />        bootstrap.min</pre></p><h3>application/<strong>init</strong>.py</h3><pre><code>from flask import Flask<br />app = Flask(__name__)<br /># static 폴더 경로를 지정해 줍니다. debug일땐 ‘static’폴더로 경로를 설정하고 나머지는 ‘static-build’를 경로로 잡습니다.<br />app.static_folder = 'static-build'<br />if app.debug:<br />        app.static_folder = 'static'<br /><br />if __name__ == '__main__':<br />    app.run(host='0.0.0.0', port=5000)<br /></code></pre><h3>application/static/js/app.js</h3><p>자바스크립트 어플리케이션 파일입니다.<br />requirejs의 기본 설정을 담고 있습니다.<br /><pre><code>require.config({<br />    "baseUrl": "/static/js",<br />    "paths": {<br />        "jquery": [<br />            "//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min",<br />            "vendor/jquery-1.10.1.min"<br />        ],<br />        "jquery.bootstrap": [<br />            "//netdna.bootstrapcdn.com/bootstrap/3.0.0-rc1/js/bootstrap.min",<br />            "vendor/bootstrap.min"<br />        ],<br />    },<br />    shim: {<br />        "jquery.bootstrap": {<br />            deps: ["jquery"],<br />            exports: '$.fn.bootstrap'<br />        },<br />        enforceDefine: true<br />    }<br />});<br /><br />requirejs(['jquery','jquery.bootstrap'],<br />    function ($) {<br />    // 어플리케이션 코드 <br />    }<br />);</code></pre></p><h3>/build/build.js</h3><p>RequireJS용 build파일입니다.</p><p><pre><code>{<br />    appDir: '../application/static',<br />    baseUrl: 'js/vendor',<br />    mainConfigFile: '../application/static/js/app.js',<br />    paths: {<br />        "jquery": "jquery-1.10.1.min",<br />        "jquery.bootstrap": "bootstrap.min",<br />    },<br />    dir: '../application/static-build',<br />    optimize: "uglify2",<br />    optimizeCss: "standard.keepLines",<br />    removeCombined: true, // combine된 파일은 남겨두지 않습니다.<br />    preserveLicenseComments: false,<br />    modules: [<br />        {<br />            name: '../app'<br />        }<br />    ]<br />}<br /></code></pre></p><h3>프로젝트 루트 페이지에서 다음을 실행합니다.</h3><p>JS/CSS파일을 최적화 하여 application/static-build 폴더에 저장합니다.<br /><code> node ./build/r.js -o ./build/build.js</code></p><p>단 이는 js와 css만 최적화를 해 주기 때문에 Ejs 템플릿도 용량을 줄이려면 아래 커맨드를 이용하면 됩니다.<br /><code>find ./application/static-build/views -name '*.ejs' -exec sed -i '/^\s∗\/\//d' {} \;<br />find ./application/static-build/views -name '*.ejs' -exec sed -i 's/^[ \t]*//g; s/[ \t]*$//g;' {} \;<br />find ./application/static-build/views -name '*.ejs' -exec sed -i ':a;N;$!ba;s/\n/ /g' {} \;</code></p><h3>쉘 스크립트를 작성해 한번에 실행하면 간편합니다.</h3><p>optimizer.sh</p><p><code>#!/bin/sh<br />cd './build'<br />node ./r.js -o build.js<br />cd '../application/static-build/views'<br />find . -name '*.ejs' -exec sed -i '/^\s∗\/\//d' {} \;<br />find . -name '*.ejs' -exec sed -i 's/^[ \t]*//g; s/[ \t]*$//g;' {} \;<br />find . -name '*.ejs' -exec sed -i ':a;N;$!ba;s/\n/ /g' {} \;<br /></code></p><h3>참고 자료</h3><p><ul><li>RequireJS Optimizer ( <a title="RequireJS Optimizer" href="http://requirejs.org/docs/optimization.html" target="_blank">http://requirejs.org/docs/optimization.html</a>) </li><li>SED로 html 용량 줄이기 (<a title="Minify html using sed" href="http://blog.keyboardplaying.org/2012/12/02/minify-html-using-sed/" target="_blank">http://blog.keyboardplaying.org/2012/12/02/minify-html-using-sed/</a>)</li></ul></p>
