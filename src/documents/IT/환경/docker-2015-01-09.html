---
layout: IT
title: Docker
date: '2015-01-09'
comments: true
adsense: true
ignored: true
tags:
- docker
- IT
- linux
- "배포"
- "환경"
---

<h2 id="article_summary" class="summary">매번 반복되는 지루한 일상(환경 구축)은 가라. Docker.</h2><p>작년 여름에 Docker를 전해 들었다.<br />‘거 참 괜찮네.’란 생각이 들었지만 직접 써본 건 바닥에 낙엽이 깔리고 나서였다.<br />그래도 이제는 손에 좀 익었기에 Docker에 대해 몇 자 적어본다.</p><p>소프트웨어 개발을 대략적인 과정은 다음과 같다.<br />환경 구축(개발) -&gt; 개발 -&gt; 환경 구축(테스트) -&gt; 테스트 -&gt; 환경 구축(배포) -&gt; 배포<br />Ax -&gt; B -&gt; Ay -&gt; C -&gt; Az -&gt; D</p><p>환경 구축이라는 작업이 반복적으로 이루어진다.<br />환경을 구축하는 것은 중요하지만, 어지간히 귀찮아서 여러 번 다시 하기 싫은 일이다.<br />그래서 예로부터 이런 환경 설정을 쉽게 도와주는 도구들이 개발자를 도왔다.<br />윈도즈 사용자라면 지금 환경을 통째로 구워서 어디서나 같은 작업 환경을 금세 되돌릴 수 있는(예를 들면 게임과 애드온이라든가...) 노턴 고스트라는 도구를 익히 들어봤을 것이다. 웹 개발자라면 APM(Apache + Php + Mysql) 환경 구축을 돕는 LAMP, WAMP, MAMP라는 녀석들과 가깝게 지냈을 것이다. 자바와 루비, 파이썬, 노드JS 등도 인기가 많아서 호스팅 업체에서는 이들을 위한 환경을 미리 구축하고는 OO호스팅, XX호스팅이라며 상품을 만들어 팔기도 한다. 그렇지만 수많은 개발 언어(<a href="http://en.wikipedia.org/wiki/List_of_programming_languages" target="_blank">http://en.wikipedia.org/wiki/List_of_programming_languages</a>)중에 별로 인기가 없는 언어로 자신만의 환경을 구축하려면? 그리고 이런 환경을 다른 머신에 또 구축하려면? 우공(愚公)이 산을 옮기듯 삽질을 아주 여러 번 해야 한다. 이건 너무 불공평하다. 지금은 민주주의 시대인데, 소수 언어 사용자도 편리할 권리가 있잖은가? 그래서 Vagrant(<a href="https://www.vagrantup.com/" target="_blank">https://www.vagrantup.com/</a>)라는 멋진 녀석이 나왔다. Vagrant를 이용해서 환경을 한 번 구축해 두면, 다른 머신에서 언제나 꺼내 쓸 수 있다. 다만 여전히 문제가 있었으니 가상머신에 종속되기 때문에 덩치가 크고, 자원을 많이 잡아먹는다. 그러니 넉넉지 못한 환경에서 vagrant를 돌리면 만족스러운 성능을 기대하기 어렵다. 이에 반해 Docker는 LXC(<a href="http://en.wikipedia.org/wiki/LXC" target="_blank">http://en.wikipedia.org/wiki/LXC</a>)를 통해 kernel cgroup 과 namespacing을 이용하니 훨씬 가볍다. 다만 이는 리눅스 시스템에서 사용할 때 이야기고, 애플 OS X나 마이크로소프트 Windows에서는 boot2docker(<a href="https://github.com/boot2docker/boot2docker" target="_blank">https://github.com/boot2docker/boot2docker</a>)등의 도움을 받아야 한다. Vagrant + Docker도 썩 괜찮은 조합이라고 한다.</p><h3>Docker를 써보자.</h3><h3>설치</h3><p><a href="https://docs.docker.com/installation/" target="_blank">https://docs.docker.com/installation/</a> 문서를 참조한다.</p><h4>Arch 리눅스</h4><p><code>sudo pacman -S docker<br />sudo systemctl enable docker</code></p><h5>Arch 리눅스에서 sudo 없이 docker를 사용하고 싶다면 아래 커맨드를 실행한다.</h5><p><a href="https://wiki.archlinux.org/index.php/Docker" target="_blank">https://wiki.archlinux.org/index.php/Docker</a></p><p><code>gpasswd -a &lt;user&gt; docker</code></p><h4>Ubuntu 리눅스</h4><p>문서(<a href="https://docs.docker.com/installation/ubuntulinux/" target="_blank">https://docs.docker.com/installation/ubuntulinux/</a>) 에 따르면<br />Ubuntu-maintained Package와 Docker-maintained Package가 있다.<br />Ubuntu-maintained Package를 설치하면 버전이 낮아서 Dockerfile에서 설정한 ENV를 WORKDIR에서 인식하지 못하는 문제가 발생한다.</p><h5>Ubuntu 리눅스에서 sudo 없이 docker를 사용하고 싶다면 아래 커맨드를 실행한다.</h5><p><code>groupadd docker<br />gpasswd -a &lt;user&gt; docker<br />service docker.io restart</code><br />그리고 로그아웃하고 다시 로그인한다.(재부팅)</p><h4>설치 오류 해결</h4><h5>Your kernel does not support cgroup swap limit</h5><p><code>/etc/default/grub<br />GRUB_CMDLINE_LINUX="cgroup_enable=memory swapaccount=1"</code><br /><code>$ sudo update-grub</code><br />그리고 재부팅한다.</p><br /><h5>error: cannot run ssh: No such file or directory fatal: unable to fork</h5><p>경로 문제이다. 경로(path)에 다음을 추가한다. <br /><code>/nvm/{nodeJS version x.xx.xx}/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</code></p><br /><h3>Docker를 익히는데 도움이 되는 문서</h3><p><a href="http://blog.nacyot.com/articles/2014-01-27-easy-deploy-with-docker/" target="_blank">http://blog.nacyot.com/articles/2014-01-27-easy-deploy-with-docker/</a><br /><a href="%20http:/forum.docker.co.kr/t/docker-docker-howto/68" target="_blank"> http://forum.docker.co.kr/t/docker-docker-howto/68</a><br /><a href="%20https:/www.docker.com/" target="_blank"> https://www.docker.com/</a><br /><a href="%20http:/dockerbook.com/" target="_blank"> http://dockerbook.com/</a><br /><a href="%20https:/coderwall.com/p/2es5jw/docker-cheat-sheet-with-examples" target="_blank"> https://coderwall.com/p/2es5jw/docker-cheat-sheet-with-examples</a><br /><a href="%20https:/github.com/wsargent/docker-cheat-sheet" target="_blank"> https://github.com/wsargent/docker-cheat-sheet</a></p><h3>자주 쓰는 Docker 명령어</h3><h4>Dockerfile 빌드(build)</h4><p>Dockerfile이 있는 디렉토리에서 실행한다. --no-cache는 캐쉬를 사용하지 않는 옵션이다.<br /><code>docker build -t "&lt;tag : user/repository&gt;" --no-cache .</code><br />사용 예)<br /><code>docker build -t "dorajistyle/flask-canjs-i18n-boilerplate" --no-cache .</code><br /><h4>entry point 덮어쓰기</h4><p>주로 이미지나 컨테이너에서 bash 쉘을 실행하기 위해 쓴다. -it는 STDIN을 허용하는 pty를 여는 옵션이다.<br /><code>docker exec -it &lt;container-id&gt; &lt;command&gt;<br />docker run -it &lt;image-id&gt; &lt;command&gt;<br />docker run -it --entrypoint &lt;command&gt; &lt;image-id&gt;</code><br /><h5>cannot execute binary file 오류가 뜨면 아래 커멘드를 쓴다.</h5><p><code>docker run -it --entrypoint &lt;command&gt; &lt;image-id&gt; -s</code></p><h2>이미지 실행</h2><p>--publish, -p 옵션은 컨테이너의 포트를 호스트포트로 넘겨준다. 6060:8080이면 호스트에서 6060포트로 접속하면 컨테이너의 8080포트로 연결된다.<br />--name 옵션은 컨테이너에 이름을 붙여준다.<br />--rm 옵션은 실행된 컨테이너가 중지되면 컨테이너를 자동으로 지워준다.<br />-d 옵션은 데몬으로 실행한다.<br /><code>docker run --publish &lt;host-port&gt;:&lt;container-port&gt; --name &lt;container-name&gt; --rm &lt;image-name&gt;<br />docker run -dp 6060:3001 &lt;host-port&gt;:&lt;container-port&gt; &lt;image-name&gt;</code><br /></p><p>사용 예)<br /><code>docker run --p 6060:5050 --name fcib --rm dorajistyle/flask-canjs-i18n-boilerplate<br />docker run -dp 6060:3001 my-image</code></p><h2>실행중인 컨테이너 중지</h2><p><code>docker stop &lt;container-id&gt;</code></p><h2>이미지에 태그 달기</h2><p><code>docker tag "user/tag"</code></p><h2>docker.io에 이미지 등록하기</h2><p>docker허브에 등록한뒤에 로그인하고 push하면 된다. image-tag는 / 형식으로 쓴다.<br /><code>docker login<br />docker push &lt;image-tag&gt;</code></p><h4>쓰지 않는 컨테이너와 이미지 지우기.</h4><p><code>docker stop $(docker ps -a -q) && docker rm $(docker ps -a -q) && docker images --no-trunc| grep none | awk '{print $3}' | xargs -r docker rmi</code></p><p>docker ps의 -a옵션은 모든 컨테이너를 보여주는 것이고, -q옵션은 컨테이너의 다른 정보 없이 id만 보여주라는 것이다.<br />위 커멘드는 3 부분으로 나뉜다.<br /><code>docker stop $(docker ps -a -q)  //  모든 컨테이너 중지<br />docker rm $(docker ps -a -q) // 모든 컨테이너 삭제<br />docker images --no-trunc| grep none | awk '{print $3}' | xargs -r docker rmi // 알수 없는 이름의 모든 이미지를 지운다.</code><br /></p><h2>컨테이너 IP주소 받아오기</h2><p><code>docker inspect &lt;container-id&gt;<br />docker inspect -f '{{ .NetworkSettings.IPAddress }}' &lt;container-id&gt;<br />docker inspect &lt;container-id&gt; | grep IPAddress | cut -d '"' -f 4<br />docker run &lt;image-id&gt; ip -4 -o addr show eth0</code></p><br /><h3>Dockerfile 잘 쓰기</h3><ul><li>캐쉬를 잘 활용한다.</li><li>태그를 쓴다.</li><li>base이미지로 작은 것을 쓴다. (ubuntu 보다는 debian)</li><li>공통된 작업은 묶어서 한다. (예 : RUN apt-get install A B C D E F)</li><li>용도에 맞게 base이미지를 만들어서 활용한다. (RoR용 base, 파이썬용 base, Golang용 base등)</li></ul><h3>Docker 빌드 자동화</h3><p>Docker허브를 이용하면 github.com이나 bitbucket.org의 저장소가 변경될때마다 자동으로 빌드되도록 할 수 있다.<br /><a href="http://docs.docker.com/userguide/dockerrepos/" target="_blank">http://docs.docker.com/userguide/dockerrepos/</a></p><h3>Docker Remote API의 웹 인터페이스</h3><p><a href="https://github.com/crosbymichael/dockerui" target="_blank">https://github.com/crosbymichael/dockerui</a></p><h3>CI(Continuous Integration) 도구</h3><p><a href="https://github.com/drone/drone" target="_blank">https://github.com/drone/drone</a><br /><a href="https://github.com/Strider-CD/strider" target="_blank">https://github.com/Strider-CD/strider</a></p><p>Docker를 쓰면서 궁금했던 점이 두 가지 있다. 하나는 'Dockerfile에서 Private Repository를 clone하려면 어떻게 해야 할까?' 이고, 또 다른 하나는 '확장은 어떻게 해야 할까?'이다.</p><h3>Private 저장소를 Dockerfile에서 불러오기.</h3><p>스텍오버플로우 질문을 찾아보니 아래 처럼 하면 된다고 한다.</p><code># private key를 복사한다.<br />ADD id_rsa /root/.ssh/id_rsa<br /># known_hosts 파일을 만든다.<br />RUN touch /root/.ssh/known_hosts<br /># bitbuckets키(다른 저장소를 이용한다면, 다른 저장소의 키)를 known_hosts에 추가한다.<br />RUN ssh-keyscan bitbucket.org >> /root/.ssh/known_hosts</code><br /><p>위 방법은 Dockerfile과 id_rsa가 같은 경로에 있어야만 한다.<br />단일 Dockerfile만으로는 방법이 없을까?<br />RUN command안에 키를 넣어 버리는 것이다. Dockerfile이 유출되면 Private Key도 노출된다는 단점이 있지만, 이는 위의 방법도 마찬가지다. Dockerfile과 Private key 파일이 함께 있을테니까. 그래도 보안을 위해서 Dockerfile에 사용할 키는 저장소에서 read권한만 가진 배포용 권한만 주는것이 좋다.<br />아래처럼 넣어주면 된다.<br /><code>RUN mkdir -p /root/.ssh && str="-----BEGIN RSA PRIVATE KEY-----blahblahblah-----END RSA PRIVATE KEY-----" && echo | sed "i$str" > /root/.ssh/id_rsa && \<br />echo "ssh-rsa blapublahpublah" > /root/.ssh/id_rsa.pub && \<br />chmod 600 /root/.ssh/id_rsa && \<br />printf "Host bitbucket.org\n\tStrictHostKeyChecking no\n" >> /root/.ssh/config</code><br /><br /><h3>Docker를 이용한다면 확장은 어떻게 해야 할까?</h3><p>문서(<a href="http://www.centurylinklabs.com/auto-loadbalancing-with-fig-haproxy-and-serf" target="_blank">http://www.centurylinklabs.com/auto-loadbalancing-with-fig-haproxy-and-serf</a>/)에서<br /><a href="%20http:/www.fig.sh/" target="_blank"> http://www.fig.sh/</a> 와 <a href="http://www.haproxy.org/" target="_blank">http://www.haproxy.org/</a> 그리고 <a href="https://www.serfdom.io/" target="_blank">https://www.serfdom.io/</a>를 이용한 로드벨런싱을 설명하고 있다.<br />그리고 문서(<a href="http://stackoverflow.com/questions/18285212/how-to-scale-docker-containers-in-production" target="_blank">http://stackoverflow.com/questions/18285212/how-to-scale-docker-containers-in-production</a>)에 따르면, 확장을 돕는 다양한 서비스가 나와있으니, 구미에 맞는 서비스를 이용하면 되겠다.<br />아마존의 Elastic Beanstalk에서도 Docker를 지원하므로, AWS에 익숙하다면 이를 이용하면 편리하다. 이 내용은 추후에 다시 다루겠다.</p><br /><h4>확장과 로드밸런싱을 돕는 도구들</h4><ul><li><a href="https://flynn.io/" target="_blank">https://flynn.io/</a></li><li><a href="http://deis.io/" target="_blank">http://deis.io/</a></li><li><a href="https://github.com/progrium/dokku" target="_blank">https://github.com/progrium/dokku</a></li><li><a href="https://coreos.com/" target="_blank">https://coreos.com/</a></li><li><a href="https://mesosphere.com/docs/tutorials/launch-docker-container-on-mesosphere/" target="_blank">https://mesosphere.com/docs/tutorials/launch-docker-container-on-mesosphere/</a></li><li><a href="https://wiki.openstack.org/wiki/Docker" target="_blank">https://wiki.openstack.org/wiki/Docker</a></li><li><a href="http://www.sebastien-han.fr/blog/2013/10/31/build-a-paas-zone-within-your-openstack-cloud/" target="_blank">http://www.sebastien-han.fr/blog/2013/10/31/build-a-paas-zone-within-your-openstack-cloud/</a></li><li><a href="http://shipyard-project.com/" target="_blank">http://shipyard-project.com/</a></li><li><a href="http://blog.tsuru.io/architecture/2014/04/04/running-tsuru-in-production-scaling-and-segregating-docker-containers.html" target="_blank">http://blog.tsuru.io/architecture/2014/04/04/running-tsuru-in-production-scaling-and-segregating-docker-containers.html</a></li><li><a href="https://github.com/signalfuse/maestro-ng" target="_blank">https://github.com/signalfuse/maestro-ng</a></li><li><a href="http://decking.io/" target="_blank">http://decking.io/</a></li><li><a href="https://aws.amazon.com/ecs/details/" target="_blank">https://aws.amazon.com/ecs/details/</a></li><li><a href="http://panamax.io/" target="_blank">http://panamax.io/</a></li></ul><br /><h3>참고자료</h3><ul><li><a style="margin: 0px; padding: 0px; border: 0px; line-height: 1.571428em; cursor: pointer; color: #047ac6;" href="http://stackoverflow.com/questions/16647069/should-i-use-vagrant-or-docker-io-for-creating-an-isolated-environment" target="_blank" shape="rect">http://stackoverflow.com/questions/16647069/should-i-use-vagrant-or-docker-io-for-creating-an-isolated-environment</a></li><li><a style="margin: 0px; padding: 0px; border: 0px; line-height: 1.571428em; cursor: pointer; color: #047ac6;" href="http://blog.zenika.com/index.php?post/2014/10/07/Setting-up-a-development-environment-using-Docker-and-Vagrant" target="_blank" shape="rect">http://blog.zenika.com/index.php?post/2014/10/07/Setting-up-a-development-environment-using-Docker-and-Vagrant</a></li><li><a style="margin: 0px; padding: 0px; border: 0px; line-height: 1.571428em; cursor: pointer; color: #047ac6;" href="https://meta.discourse.org/t/low-on-disk-space-cleaning-up-old-docker-containers/15792" target="_blank" shape="rect">https://meta.discourse.org/t/low-on-disk-space-cleaning-up-old-docker-containers/15792</a></li><li><a style="margin: 0px; padding: 0px; border: 0px; line-height: 1.571428em; cursor: pointer; color: #047ac6;" href="http://stackoverflow.com/questions/18285212/how-to-scale-docker-containers-in-production" target="_blank" shape="rect">http://stackoverflow.com/questions/18285212/how-to-scale-docker-containers-in-production</a></li><li><a style="margin: 0px; padding: 0px; border: 0px; line-height: 1.571428em; cursor: pointer; color: #047ac6;" href="http://stackoverflow.com/questions/17157721/getting-a-docker-containers-ip-address-from-the-host" target="_blank" shape="rect">http://stackoverflow.com/questions/17157721/getting-a-docker-containers-ip-address-from-the-host</a></li><li><a style="margin: 0px; padding: 0px; border: 0px; line-height: 1.571428em; cursor: pointer; color: #047ac6;" href="http://crosbymichael.com/dockerfile-best-practices.html" target="_blank" shape="rect">http://crosbymichael.com/dockerfile-best-practices.html</a></li><li><a style="margin: 0px; padding: 0px; border: 0px; line-height: 1.571428em; cursor: pointer; color: #047ac6;" href="http://crosbymichael.com/dockerfile-best-practices-take-2.html" target="_blank" shape="rect">http://crosbymichael.com/dockerfile-best-practices-take-2.html</a></li><li><a style="margin: 0px; padding: 0px; border: 0px; line-height: 1.571428em; cursor: pointer; color: #047ac6;" href="http://thenewstack.io/understanding-the-docker-cache-for-faster-builds/" target="_blank" shape="rect">http://thenewstack.io/understanding-the-docker-cache-for-faster-builds/</a></li><li><a style="margin: 0px; padding: 0px; border: 0px; line-height: 1.571428em; cursor: pointer; color: #047ac6;" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-docker-registry-on-ubuntu-14-04" target="_blank" shape="rect">https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-docker-registry-on-ubuntu-14-04</a></li><li><a style="margin: 0px; padding: 0px; border: 0px; line-height: 1.571428em; cursor: pointer; color: #047ac6;" href="http://stackoverflow.com/questions/23391839/clone-private-git-repo-with-dockerfile" target="_blank" shape="rect">http://stackoverflow.com/questions/23391839/clone-private-git-repo-with-dockerfile</a></li></ul>
