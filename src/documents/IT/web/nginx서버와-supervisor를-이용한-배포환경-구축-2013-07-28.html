---
layout: IT
title: NGINX서버와 supervisor를 이용한 배포환경 구축
date: '2013-07-28'
comments: true
adsense: true
ignored: false
tags:
- development
- IT
- NGINX
- supervisor
- web
- "구축"
- "배포"
- "환경"
---

<h2 id="article_summary" class="summary">개발이 끝났다면? NGINX서버와 supervisor를 써서 배포해 봅시다.</h2><h3>NGINX</h3><p><strong>/etc/nginx/nginx.conf</strong><br /><code>http {<br />keepalive_timeout  65;<br />gzip  on;<br />add_header    Cache-Control  private;<br />gzip_static on;<br />gzip_http_version   1.1;<br />gzip_proxied        expired no-cache no-store private auth;<br />gzip_disable        "MSIE [1-6]\.";<br />gzip_vary           on;<br />gzip_types    application/x-javascript text/css *;<br /><br />map $http_x_requested_with $nocache {<br />default 0;<br />XMLHttpRequest 1;<br />}<br /><br />include /etc/nginx/sites-enabled/*;<br />}</code></p><p>/etc/nginx/sites-available/myapp.conf</p><p><code>server {<br />listen 80;<br />server_name _;<br /><br />root /path/myapp;<br /><br />access_log /path/myapp/logs/access.log;<br />error_log /path/myapp/logs/error.log;<br /><br />proxy_cache_bypass  $nocache;<br />proxy_no_cache      $nocache;<br /><br />location /static {<br />expires modified +24h;<br />alias /path/myapp/application/frontend/static-build;<br />}<br /><br />location /api/_uploads {<br />expires modified +24h;<br />alias /path/myapp/images;<br />}<br /><br />location / {<br />proxy_pass         http://127.0.0.1:8000;<br />proxy_redirect     off;<br /><br />proxy_set_header   Host             $host;<br />proxy_set_header   X-Real-IP        $remote_addr;<br />proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;<br />proxy_connect_timeout 30;<br />proxy_read_timeout 30;<br />}<br />}<br /></code><br />* static 폴더를 설정할 때 주의 점<br />root를 사용할 땐 static 폴더의 상위 폴더를 지정하고,<br />alias를 사용할 땐 static폴더를 지정한다.</p><p>Upload file size setting<br /><code>client_max_body_size</code></p><p><strong>권한이 필요합니다. 오류 해결.</strong><br />error log.<br />2013/07/10 18:31:54 [crit] 23626#0: *127 stat() "PATH" failed (13: Permission denied) request: "GET PATH HTTP/1.1", host: "localhost", referrer: "http://localhost/"<br /><code>chmod 751 PATH</code><br />all path in PATH should have access permission.<br />PATH에 모든 경로에 접근 권한이 필요하다.<br />예) /home/example/applications/myapp 경로에 접근해야 할 땐.<br />/ , /home, /home/example, /home/example/application, /home/example/applications/myapp 에 접근 권한이 필요하다.</p><p><strong>location 설정</strong><br />인덱스 파일이 없을때 오류 처리와 디렉토리 목록을 보여준다.<br /><code>autoindex on;</code></p><p><strong>설정 파일 심볼릭 링크 걸기</strong><br /><code>ln -s /etc/nginx/sites-available/myapp.conf /etc/nginx/sites-enabled/</code></p><p><strong>Arch Linux 기준 nginx 서버 실행과 정지.</strong><br /><code>sudo systemctl start nginx<br />sudo systemctl stop nginx</code></p><br /><h3>supervisor</h3><p><strong>/etc/supervisor.d/myapp.ini</strong><br /><code>[program:myapp]<br />command = gunicorn --debug --log-level debug -w 4 -b 127.0.0.1:8000 wsgi:application<br />; command = twistd web --port 5000 --wsgi wsgi.application<br />directory = /path/myapp<br />user = root<br />autostart=true<br />autorestart=true<br />; stdout_logfile=NONE<br />; stderr_logfile=NONE<br />; Handy for debugging:<br />stdout_logfile=/var/log/supervisor/webapp.stdout<br />stderr_logfile=/var/log/supervisor/webapp.stderr <br /></code></p><p><strong>supervisor 실행법</strong><br />데몬 실행(테스트를 위해 프론트에서 실행함)<br /><code>sudo supervisord -n</code><br />변경사항을 다시 읽고 업데이트 함.<br /><code>sudo supervisorctl reread<br />sudo supervisorctl update<br />supervisor 실행<br />sudo supervisorctl start myapp<br />supervisor 재실행<br />supervisorctl restart webapp</code></p><br />※ 만약 고정 아이피에서 서비스를 한다면 gunicorn을 실행할 때 localhost가 아닌 고정 아이피 주소(예: gunicorn -b 123.456.789.000:8000)로 실행해야 외부에서 접근이 가능하다.<br />물론 nginx설정도 그에 맞게 변경해야 한다.<br /><br /><h3>참고 자료</h3><ul><li><a href="http://www.onurguzel.com/how-to-run-flask-applications-with-nginx-using-gunicorn/">how-to-run-flask-applications-with-nginx-using-gunicorn</a></li><li><a href="http://www.onurguzel.com/managing-gunicorn-processes-with-supervisor/">managing-gunicorn-processes-with-supervisor</a></li><li><a href="http://www.michielovertoom.com/freebsd/flask-gunicorn-nginx-supervisord/">lask-gunicorn-nginx-supervisord</a></li></ul>
